<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Clark County Property Lookup</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family: system-ui, Arial; max-width:900px; margin:24px auto; }
    input, button { padding:8px; margin:4px; }
    #result { white-space:pre-wrap; background:#fafafa; padding:12px; border:1px solid #eee; margin-top:12px; }
    #map { height: 400px; margin-top: 12px; border: 1px solid #ccc; }
    
    /* Source Manager Styles */
    .source-box { background: #f0fdf4; border: 1px solid #bbf7d0; padding: 15px; margin-top: 30px; border-radius: 8px; }
    .source-item { display: flex; justify-content: space-between; align-items: center; background: white; padding: 8px; margin: 4px 0; border: 1px solid #ddd; }
    .source-item.inactive { opacity: 0.6; background: #f3f4f6; }
    .badge { font-size: 0.75rem; background: #e0f2fe; color: #0369a1; padding: 2px 6px; border-radius: 4px; margin-right: 8px; }
    .btn-sm { padding: 4px 8px; font-size: 0.8rem; cursor: pointer; }
    .btn-red { background: #fee2e2; color: #b91c1c; border: none; }
    .btn-green { background: #dcfce7; color: #15803d; border: none; }
  </style>
</head>
<body>
  <h2>Clark County Property Lookup</h2>
  
  <div>
    <label>Address: <input id="addr" size="50" placeholder="e.g. 111 W 8th St, Vancouver, WA"></label>
    <button onclick="searchAddress()">Search</button>
  </div>
  <div>
    <label>Or Parcel: <input id="parcel" placeholder="986035637"></label>
    <button onclick="searchParcel()">Find Parcel</button>
  </div>

  <div id="result">Results will appear here.</div>
  <div id="link-container"></div>
  <div id="map"></div>

  <div class="source-box">
    <h3>üì° Data Source Manager</h3>
    <p style="font-size:0.9rem; color:#666;">Manage the external APIs used for the Zonda Reports.</p>
    
    <div id="sources-list">Loading sources...</div>
    
    <div style="margin-top:10px; border-top:1px solid #ccc; padding-top:10px;">
        <h4>Add New Source</h4>
        <input id="new-name" placeholder="Name (e.g. WalkScore API)">
        <input id="new-url" placeholder="URL" size="40">
        <input id="new-cat" placeholder="Category" size="15">
        <button onclick="addSource()">+ Add</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --- Existing Map/Search Logic (Simplified for brevity) ---
    let map, marker;
    function initMap(lat=45.63, lon=-122.66) { 
        map = L.map('map').setView([lat, lon], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); 
    }
    function updateMap(lat, lon, label) {
        if(!map) initMap(lat, lon);
        else map.setView([lat, lon], 16);
        if(marker) map.removeLayer(marker);
        marker = L.marker([lat, lon]).addTo(map).bindPopup(label).openPopup();
    }
    async function searchParcel() {
        const p = document.getElementById('parcel').value;
        const res = await fetch(`/api/find_parcel?parcel=${p}`).then(r=>r.json());
        document.getElementById('result').innerText = JSON.stringify(res, null, 2);
        // Show report link if found
        if(res.result) {
            const pid = res.result.features[0].attributes.SERIAL_NUM;
            document.getElementById('link-container').innerHTML = `<a href="/report?parcel=${pid}" target="_blank" style="display:block; background:#0284c7; color:white; padding:10px; text-align:center; text-decoration:none; margin-top:10px;">üìÑ Generate Zonda Report</a>`;
        }
    }
    // (Keep your searchAddress function from before)

    // --- NEW: Source Manager Logic ---
    async function loadSources() {
        const sources = await fetch('/api/sources').then(r => r.json());
        const list = document.getElementById('sources-list');
        list.innerHTML = "";
        
        sources.forEach(s => {
            const div = document.createElement('div');
            div.className = `source-item ${s.active ? '' : 'inactive'}`;
            div.innerHTML = `
                <div>
                    <span class="badge">${s.category || 'General'}</span>
                    <strong>${s.name}</strong>
                    <br><small style="color:#888">${s.url}</small>
                </div>
                <div>
                    <button class="btn-sm ${s.active ? 'btn-red' : 'btn-green'}" onclick="toggleSource('${s.id}')">
                        ${s.active ? 'Disable' : 'Enable'}
                    </button>
                    <button class="btn-sm" onclick="deleteSource('${s.id}')">‚ùå</button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    async function toggleSource(id) {
        await fetch(`/api/sources/${id}/toggle`, { method: 'POST' });
        loadSources();
    }

    async function deleteSource(id) {
        if(!confirm("Remove this source?")) return;
        await fetch(`/api/sources/${id}`, { method: 'DELETE' });
        loadSources();
    }

    async function addSource() {
        const name = document.getElementById('new-name').value;
        const url = document.getElementById('new-url').value;
        const cat = document.getElementById('new-cat').value;
        if(!name || !url) return alert("Name and URL required");
        
        await fetch('/api/sources', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name, url, category: cat })
        });
        document.getElementById('new-name').value = "";
        document.getElementById('new-url').value = "";
        loadSources();
    }

    // Initialize
    initMap();
    loadSources();
  </script>
</body>
</html>