<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Clark County Property Lookup</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family: system-ui, Arial; max-width:900px; margin:24px auto; }
    input, button { padding:8px; margin:4px; }
    #result { white-space:pre-wrap; background:#fafafa; padding:12px; border:1px solid #eee; margin-top:12px; }
    #map { height: 400px; margin-top: 12px; border: 1px solid #ccc; }
    .links-box { background: #e0f2fe; padding: 10px; margin-top: 10px; border-radius: 5px; }
    .links-box a { display: block; margin: 5px 0; color: #0284c7; font-weight: bold; text-decoration: none; }
    .links-box a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <h2>Clark County Property Lookup (demo)</h2>
  <div>
    <label>Address: <input id="addr" size="50" placeholder="e.g. 111 W 8th St, Vancouver, WA"></label>
    <button onclick="searchAddress()">Search</button>
  </div>
  <div>
    <label>Or Parcel / PAN: <input id="parcel" placeholder="986035637"></label>
    <button onclick="searchParcel()">Find Parcel</button>
  </div>

  <div id="result">Results will appear here.</div>
  <div id="link-container"></div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  let map, marker;

  function initMap(lat = 45.6387, lon = -122.6615) {
    map = L.map('map').setView([lat, lon], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
  }

  function updateMap(lat, lon, label) {
    if (!map) initMap(lat, lon);
    else map.setView([lat, lon], 17);
    if (marker) map.removeLayer(marker);
    marker = L.marker([lat, lon]).addTo(map).bindPopup(label || 'Location').openPopup();
  }

  function setResult(text){ document.getElementById('result').textContent = text; }
  
  async function displayLinks(parcelId) {
    const container = document.getElementById('link-container');
    container.innerHTML = "Loading links...";
    
    const links = await fetch(`/api/links?parcel=${encodeURIComponent(parcelId)}`).then(r => r.json());
    
    let html = `<div class="links-box"><h3>Property Links for #${parcelId}</h3>`;
    for (const [key, url] of Object.entries(links)) {
        html += `<a href="${url}" target="_blank">➜ ${key}</a>`;
    }
    html += `</div>`;
    container.innerHTML = html;
  }

  async function searchAddress() {
    const a = document.getElementById('addr').value.trim();
    if (!a) return alert('enter address');
    setResult('Geocoding...');
    document.getElementById('link-container').innerHTML = "";
    
    const g = await fetch('/api/geocode?q=' + encodeURIComponent(a)).then(r => r.json());
    
    if (g.candidates && g.candidates.length > 0) {
      const c = g.candidates[0];
      const y = c.location.y, x = c.location.x;
      setResult(`Found: ${c.address}\nQuerying parcel boundaries...`);
      updateMap(y, x, c.address);

      const p = await fetch(`/api/find_parcel?lat=${y}&lon=${x}`).then(r => r.json());
      
      // FIXED: Look for correct Clark County Field Names
      const attrs = p.features?.[0]?.attributes;
      const parcelId = attrs?.SERIAL_NUM || attrs?.PARCEL_NUMBER || attrs?.PropertyID;

      if (parcelId) {
          setResult(`Found Parcel #${parcelId}\nOwner: ${attrs.OwnerName || 'Unknown'}\nSize: ${attrs.LandAcres} acres`);
          displayLinks(parcelId);
      } else {
          setResult("Address found, but no matching parcel record in County GIS.");
      }
    } else {
      setResult('Address not found.');
    }
  }

  async function searchParcel() {
    const parcel = document.getElementById('parcel').value.trim();
    if (!parcel) return alert('enter parcel');
    setResult('Searching parcel...');
    document.getElementById('link-container').innerHTML = "";

    const p = await fetch('/api/find_parcel?parcel=' + encodeURIComponent(parcel)).then(r => r.json());
    
    if (p.result && p.result.features) {
        const attrs = p.result.features[0].attributes;
        const parcelId = attrs.SERIAL_NUM || attrs.PARCEL_NUMBER || parcel; // Use what we found
        setResult(JSON.stringify(attrs, null, 2));
        displayLinks(parcelId);
    } else {
        setResult("Parcel not found.");
    }
  }

  initMap();
  </script>
</body>
</html>